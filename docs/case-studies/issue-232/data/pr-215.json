{"body":"## Summary\n\n- Reduce total shotgun shells to 20 (8 in tube + 12 reserve)\n- Add continuous drag-and-drop reload gestures for bolt open/close\n- Preserve backward compatibility with release-based gestures\n- **Updated**: Shell loading behavior preserved as original (requires RMB release)\n- **Fixed**: Increased cooldown protection (750ms) to prevent accidental bolt reopening\n- **Fixed**: Shell count now correctly uses spare magazines for ReserveAmmo\n- **Fixed**: Reserve ammo display now shows correctly (signal timing fix)\n\n## Changes\n\n### 1. Shell Count Reduction\nChanged `MaxReserveAmmo` from 24 to 12 in `resources/weapons/ShotgunData.tres`. With 8 shells in the tube magazine, this gives exactly 20 total shells on the building level as requested.\n\n**Bug fix in Shotgun._Ready()**: \n- Fixed MagazineInventory initialization to use 2 magazines (one CurrentMagazine set to 0, one spare with reserve shells)\n- The `ReserveAmmo` property returns `TotalSpareAmmo`, so reserve shells must be in spare magazines\n- Updated `LoadShell()` to consume from spare magazines correctly\n\n### 2. Reserve Ammo Display Fix\n**Root cause:** The `ShellCountChanged` signal was emitted during `_Ready()` before the shotgun was added to the player's children. GDScript handlers couldn't find the shotgun to read `ReserveAmmo`.\n\n**Fix:** Use `CallDeferred(MethodName.EmitInitialShellCount)` to emit the signal after the shotgun is added to the scene tree. This ensures the display correctly shows \"8/12\" instead of \"8/0\".\n\n### 3. Continuous Reload Gestures (Bolt Open/Close Only)\nAdded `TryProcessMidDragGesture()` method in `Scripts/Weapons/Shotgun.cs` that enables:\n\n**New fluid reload motion for bolt:**\n1. Hold RMB and drag UP â†’ opens bolt\n2. Without releasing RMB, drag DOWN â†’ closes bolt\n\n**Also works for pump-action after firing:**\n1. Fire with LMB (shotgun enters NeedsPumpUp state)\n2. Hold RMB and drag UP â†’ ejects spent shell\n3. Without releasing RMB, drag DOWN â†’ chambers next round\n\n### 4. Shell Loading Behavior (Preserved Original)\nShell loading with MMB continues to use the original release-based gesture:\n- Open bolt (RMB drag UP, release)\n- Load shell (MMB + RMB drag DOWN, release)\n- Close bolt (RMB drag DOWN, release)\n\n**Why:** Based on user feedback, the original shell loading behavior provides better control and intentionality.\n\n### 5. Bolt Close Cooldown Protection\nAdded **750ms** cooldown (history: 250ms â†’ 400ms â†’ 500ms â†’ 750ms) after closing the bolt to prevent accidental reopening due to continued mouse movement:\n- After `CompleteReload()` (reload completion)\n- After pump-down (mid-drag and release-based gestures)\n\n**Why:** User reported accidental bolt reopening during pump-action sequences. Increased cooldown provides more robust protection.\n\n**Verbose logging enabled:** Game now outputs detailed timing information to help diagnose remaining issues.\n\n### 6. Backward Compatibility\nOriginal release-based gestures still work for all operations:\n- RMB drag UP (release) â†’ action\n- RMB drag DOWN (release) â†’ action\n\n## User Feedback Integration (6 rounds)\n\n1. **\"keep original shell loading\"** â†’ Preserved release-based shell loading, kept continuous bolt open/close\n2. **\"accidental bolt opens after closing\"** â†’ Added 250ms cooldown\n3. **\"still happens during pump-action\"** â†’ Increased to 400ms\n4. **\"still 8+24 shells\"** â†’ Fixed MagazineInventory initialization\n5. **\"now 8 total (should be 8+12)\"** â†’ Fixed to use spare magazines\n6. **\"still 8/0 display, still accidental opens\"** â†’ Fixed signal timing with CallDeferred, increased cooldown to 750ms\n\n## Test Plan\n\n- [x] Verify building level starts with 20 total shells (8 in tube + 12 reserve)\n- [x] Test continuous bolt open/close: hold RMB, drag up, then down without releasing\n- [x] Test old reload gestures: RMB drag up (release), then RMB drag down (release)\n- [x] Test continuous pump-action after firing\n- [x] Verify shell loading uses original behavior (requires RMB release)\n- [ ] Verify reserve ammo display shows 12 (not 0) at game start\n- [ ] Verify bolt close cooldown (750ms) prevents accidental reopening during pump-action\n\n## Case Study\n\nDocumentation added to `docs/case-studies/issue-210/` with:\n- Timeline of events\n- User feedback analysis (6 rounds)\n- Root cause analysis for each issue\n- Resolution details\n- User-provided game logs\n\nFixes #210\n\nðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)","commits":[{"authoredDate":"2026-01-22T05:45:57Z","authors":[{"email":"drakonard@gmail.com","id":"MDQ6VXNlcjE0MzE5MDQ=","login":"konard","name":"konard"}],"committedDate":"2026-01-22T05:45:57Z","messageBody":"Adding CLAUDE.md with task information for AI processing.\nThis file will be removed when the task is complete.\n\nIssue: https://github.com/Jhon-Crow/godot-topdown-MVP/issues/210","messageHeadline":"Initial commit with task details","oid":"aa2d18520c750c79d411780c28dda3585620b2e2"},{"authoredDate":"2026-01-22T05:49:56Z","authors":[{"email":"drakonard@gmail.com","id":"MDQ6VXNlcjE0MzE5MDQ=","login":"konard","name":"konard"},{"email":"noreply@anthropic.com","id":"MDQ6VXNlcjgxODQ3","login":"claude","name":"Claude Opus 4.5"}],"committedDate":"2026-01-22T05:49:56Z","messageBody":"Changes:\n1. Reduce MaxReserveAmmo from 24 to 12 in ShotgunData.tres\n   - With 8 shells in tube, gives 20 total shells on building level\n   - Matches the issue requirement for 20 shotgun charges\n\n2. Add continuous drag gesture support in Shotgun.cs\n   - New TryProcessMidDragGesture() method detects gestures during RMB hold\n   - Enables fluid reload: hold RMB, drag UP (open bolt), drag DOWN (close)\n   - All in one continuous motion without releasing RMB\n   - Also works for pump-action cycling after firing\n\n3. Backward compatibility preserved\n   - Original release-based gestures still work as before\n   - Players can use either old or new mechanism\n\n4. Add case study documentation in docs/case-studies/issue-210/\n\nFixes #210\n\nCo-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>","messageHeadline":"Add continuous shotgun reload and reduce shells to 20 total","oid":"17f1310d519c66753aa6539dd27bb73cd1afd4f1"},{"authoredDate":"2026-01-22T05:51:40Z","authors":[{"email":"drakonard@gmail.com","id":"MDQ6VXNlcjE0MzE5MDQ=","login":"konard","name":"konard"}],"committedDate":"2026-01-22T05:51:40Z","messageBody":"This reverts commit aa2d18520c750c79d411780c28dda3585620b2e2.","messageHeadline":"Revert \"Initial commit with task details\"","oid":"a957980163096430d4c93178eedb5a6897f6f715"},{"authoredDate":"2026-01-22T06:00:10Z","authors":[{"email":"drakonard@gmail.com","id":"MDQ6VXNlcjE0MzE5MDQ=","login":"konard","name":"konard"},{"email":"noreply@anthropic.com","id":"MDQ6VXNlcjgxODQ3","login":"claude","name":"Claude Opus 4.5"}],"committedDate":"2026-01-22T06:00:10Z","messageBody":"Based on user feedback:\n- Keep continuous bolt open/close gesture (works correctly)\n- Preserve original shell loading behavior (requires RMB release)\n\nThe mid-drag gesture now returns false when MMB is held during\ndrag DOWN in Loading state, allowing the original release-based\ngesture processing to handle shell loading.\n\nAlso added case study documentation with user feedback analysis.\n\nCo-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>","messageHeadline":"Preserve original shell loading behavior in mid-drag gestures","oid":"008f28364a61426f01fe5f40bcf717801d865257"},{"authoredDate":"2026-01-22T06:04:42Z","authors":[{"email":"drakonard@gmail.com","id":"MDQ6VXNlcjE0MzE5MDQ=","login":"konard","name":"konard"},{"email":"noreply@anthropic.com","id":"MDQ6VXNlcjgxODQ3","login":"claude","name":"Claude Opus 4.5"}],"committedDate":"2026-01-22T06:04:42Z","messageBody":"After closing the bolt (either via reload completion or pump-action),\na 250ms cooldown now prevents the bolt from being immediately opened\nagain. This fixes the issue where continued mouse movement after\nclosing the bolt could accidentally trigger a bolt open gesture.\n\nThe fix covers all bolt close scenarios:\n- CompleteReload() when finishing reload sequence\n- Mid-drag pump down (continuous gesture)\n- Release-based pump down gesture\n\nAlso adds user-provided game logs to case study documentation.\n\nCo-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>","messageHeadline":"Add cooldown protection to prevent accidental bolt reopening","oid":"afcbcba4de2f3746d886b9882f27e9689daf45e0"},{"authoredDate":"2026-01-22T06:18:39Z","authors":[{"email":"drakonard@gmail.com","id":"MDQ6VXNlcjE0MzE5MDQ=","login":"konard","name":"konard"},{"email":"noreply@anthropic.com","id":"MDQ6VXNlcjgxODQ3","login":"claude","name":"Claude Opus 4.5"}],"committedDate":"2026-01-22T06:18:39Z","messageBody":"Based on user feedback that the bolt can still accidentally open\nduring pump-action chambering (after shooting), increased the cooldown\nperiod to provide more protection against accidental gestures.\n\nAlso added verbose logging for cooldown blocks to aid future debugging.\n\nCo-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>","messageHeadline":"Increase bolt close cooldown from 250ms to 400ms","oid":"31acef15d8a349366d4af32cdd9b2576f63d6066"},{"authoredDate":"2026-01-22T06:23:00Z","authors":[{"email":"drakonard@gmail.com","id":"MDQ6VXNlcjE0MzE5MDQ=","login":"konard","name":"konard"},{"email":"noreply@anthropic.com","id":"MDQ6VXNlcjgxODQ3","login":"claude","name":"Claude Opus 4.5"}],"committedDate":"2026-01-22T06:23:00Z","messageBody":"Documents all three rounds of user feedback:\n1. Shell loading should use original behavior (fixed)\n2. Bolt accidentally opens after closing (added 250ms cooldown)\n3. Bolt still opens during pump-action (increased to 400ms cooldown)\n\nCo-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>","messageHeadline":"Update case study with complete user feedback timeline","oid":"074f93b0a4b21c8968d712acd9510459a38d8fc4"},{"authoredDate":"2026-01-22T06:35:23Z","authors":[{"email":"drakonard@gmail.com","id":"MDQ6VXNlcjE0MzE5MDQ=","login":"konard","name":"konard"},{"email":"noreply@anthropic.com","id":"MDQ6VXNlcjgxODQ3","login":"claude","name":"Claude Opus 4.5"}],"committedDate":"2026-01-22T06:35:23Z","messageBody":"The shotgun was incorrectly using the MagazineInventory's StartingMagazineCount\n(default 4) to calculate reserve shells: 4 magazines Ã— 8 shells = 32 shells total.\n\nNow the shotgun properly re-initializes its reserve shell pool using\nWeaponData.MaxReserveAmmo (12), giving the correct total: 8 + 12 = 20 shells.\n\nAlso added the downloaded game log from user feedback to case study docs.\n\nCo-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>","messageHeadline":"Fix shotgun shell count to use MaxReserveAmmo from WeaponData","oid":"3aadaeadef30065666f390626ebf4024af669561"},{"authoredDate":"2026-01-22T06:36:21Z","authors":[{"email":"drakonard@gmail.com","id":"MDQ6VXNlcjE0MzE5MDQ=","login":"konard","name":"konard"},{"email":"noreply@anthropic.com","id":"MDQ6VXNlcjgxODQ3","login":"claude","name":"Claude Opus 4.5"}],"committedDate":"2026-01-22T06:36:21Z","messageBody":"Added documentation for:\n- User feedback about shell count (8+24 instead of 8+12)\n- Root cause: MagazineInventory using StartingMagazineCount default (4)\n- Resolution: Re-initialize with MaxReserveAmmo in Shotgun._Ready()\n- Note about ongoing accidental bolt opening investigation\n\nCo-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>","messageHeadline":"Update case study with feedback #4 and shell count fix analysis","oid":"5dd2a9ddd20443df21093183f6a658740001cd0a"},{"authoredDate":"2026-01-22T06:50:33Z","authors":[{"email":"drakonard@gmail.com","id":"MDQ6VXNlcjE0MzE5MDQ=","login":"konard","name":"konard"},{"email":"noreply@anthropic.com","id":"MDQ6VXNlcjgxODQ3","login":"claude","name":"Claude Opus 4.5"}],"committedDate":"2026-01-22T06:50:33Z","messageBody":"- Fix shell count: use 2 magazines in MagazineInventory so ReserveAmmo\n  property (which returns TotalSpareAmmo) works correctly\n- Set CurrentMagazine to 0 since shotgun uses separate ShellsInTube\n- Update LoadShell() to consume from spare magazines\n- Increase bolt close cooldown from 400ms to 500ms\n- Enable verbose logging to diagnose remaining accidental bolt opening\n- Add detailed timing logs for pump-down completion\n- Update case study with feedback #5 analysis\n\nFixes #210\n\nCo-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>","messageHeadline":"Fix shell count to use spare magazines and increase cooldown to 500ms","oid":"5075de67db8278bb909c5ec18dbb37f2bec630d6"},{"authoredDate":"2026-01-22T06:59:13Z","authors":[{"email":"drakonard@gmail.com","id":"MDQ6VXNlcjE0MzE5MDQ=","login":"konard","name":"konard"},{"email":"noreply@anthropic.com","id":"MDQ6VXNlcjgxODQ3","login":"claude","name":"Claude Opus 4.5"}],"committedDate":"2026-01-22T06:59:13Z","messageBody":"- Fix ShellCountChanged signal timing: Use CallDeferred to emit the\n  initial shell count signal after the shotgun is added to the scene\n  tree. This fixes the issue where GDScript handlers couldn't find the\n  shotgun to read ReserveAmmo, causing \"8/0\" display instead of \"8/12\".\n\n- Increase bolt close cooldown from 500ms to 750ms to further reduce\n  accidental bolt reopening during pump-action sequences.\n\n- Add verbose logging for release-based pump DOWN operations to help\n  diagnose any remaining timing issues.\n\nCo-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>","messageHeadline":"Fix reserve ammo display and increase cooldown to 750ms","oid":"97110cac93bfcdced14f70f32ce89523642667a5"},{"authoredDate":"2026-01-22T07:00:02Z","authors":[{"email":"drakonard@gmail.com","id":"MDQ6VXNlcjE0MzE5MDQ=","login":"konard","name":"konard"},{"email":"noreply@anthropic.com","id":"MDQ6VXNlcjgxODQ3","login":"claude","name":"Claude Opus 4.5"}],"committedDate":"2026-01-22T07:00:02Z","messageBody":"Document the root cause analysis for:\n1. Reserve ammo display showing 0 instead of 12 (signal timing issue)\n2. Accidental bolt opening during pump-action sequences\n\nCo-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>","messageHeadline":"Update case study with feedback #5/#6 analysis and fixes","oid":"cd42bfe191061c389b29ef672169f379a9cde345"}],"files":[{"path":"Scripts/Weapons/Shotgun.cs","additions":318,"deletions":8},{"path":"docs/case-studies/issue-210/README.md","additions":448,"deletions":0},{"path":"docs/case-studies/issue-210/game_log_20260122_085458.txt","additions":174,"deletions":0},{"path":"docs/case-studies/issue-210/game_log_20260122_085737.txt","additions":4615,"deletions":0},{"path":"docs/case-studies/issue-210/game_log_user_feedback5.txt","additions":1544,"deletions":0},{"path":"docs/case-studies/issue-210/game_logs/game_log_20260122_094153.txt","additions":1544,"deletions":0},{"path":"docs/case-studies/issue-210/logs/game_log_20260122_085458.txt","additions":174,"deletions":0},{"path":"docs/case-studies/issue-210/logs/game_log_20260122_091126.txt","additions":134,"deletions":0},{"path":"docs/case-studies/issue-210/logs/game_log_20260122_091335.txt","additions":168,"deletions":0},{"path":"docs/case-studies/issue-210/logs/game_log_20260122_092829.txt","additions":167,"deletions":0},{"path":"docs/case-studies/issue-210/logs/solution-draft-log-pr-1769061104361.txt","additions":4837,"deletions":0},{"path":"resources/weapons/ShotgunData.tres","additions":1,"deletions":1}],"mergedAt":"2026-01-22T07:14:49Z","title":"Update shotgun: 20 shells + continuous reload gestures"}
